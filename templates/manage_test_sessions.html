<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление тестами - HR Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f8fafc; 
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #E5E7EB;
            padding: 15px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #1DB584;
        }
        
        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .nav-item {
            color: #6B7280;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            color: #1DB584;
            background: #F0FDF4;
        }
        
        .nav-item.active {
            color: #8B5CF6;
            background: #F3E8FF;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.8rem;
            color: #7F8C8D;
        }
        
        .btn-logout {
            background: #F3F4F6;
            color: #6B7280;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .page-header {
            margin-bottom: 40px;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .page-subtitle {
            color: #7F8C8D;
            font-size: 1.1rem;
        }
        
        /* Breadcrumb */
        .breadcrumb {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #6B7280;
        }
        
        .breadcrumb a {
            color: #1DB584;
            text-decoration: none;
        }
        
        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6B7280;
            font-size: 0.9rem;
        }
        
        /* Controls */
        .controls {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .search-filters {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .search-input {
            flex: 1;
            max-width: 300px;
            padding: 10px 15px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            border-color: #8B5CF6;
            outline: none;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }
        
        .btn-create {
            background: #8B5CF6;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-create:hover {
            background: #7C3AED;
        }
        
        /* Test Sessions Table */
        .sessions-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .section-header {
            padding: 25px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2C3E50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .sessions-table th {
            background: #F9FAFB;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .sessions-table td {
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            vertical-align: top;
        }
        
        .sessions-table tr:hover {
            background: #F9FAFB;
        }
        
        /* Test Session Cards Mobile */
        .session-card {
            display: none;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #8B5CF6;
        }
        
        .session-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .candidate-name {
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 5px;
        }
        
        .session-profession {
            font-size: 0.9rem;
            color: #6B7280;
            margin-bottom: 3px;
        }
        
        .session-level {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .level-junior {
            background: #D1FAE5;
            color: #065F46;
        }
        
        .level-middle {
            background: #FEF3C7;
            color: #92400E;
        }
        
        .level-senior {
            background: #FEE2E2;
            color: #991B1B;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-value {
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 3px;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: #6B7280;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .btn-view {
            background: #EFF6FF;
            color: #3B82F6;
        }
        
        .btn-view:hover {
            background: #DBEAFE;
        }
        
        .btn-copy {
            background: #ECFDF5;
            color: #059669;
        }
        
        .btn-copy:hover {
            background: #D1FAE5;
        }
        
        .btn-delete {
            background: #FEF2F2;
            color: #EF4444;
        }
        
        .btn-delete:hover {
            background: #FEE2E2;
        }
        
        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }
        
        .status-in-progress {
            background: #DBEAFE;
            color: #1E40AF;
        }
        
        .status-completed {
            background: #D1FAE5;
            color: #065F46;
        }
        
        /* Test URL Display */
        .test-url {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #6B7280;
            background: #F9FAFB;
            padding: 8px;
            border-radius: 4px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6B7280;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .empty-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .empty-description {
            margin-bottom: 30px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            padding: 30px;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 10px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        .btn-modal-cancel {
            background: #F3F4F6;
            color: #6B7280;
        }
        
        .btn-modal-delete {
            background: #EF4444;
            color: white;
        }
        
        .btn-modal-delete:hover {
            background: #DC2626;
        }
        
        /* Loading */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Messages */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .message.success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #10B981;
        }
        
        .message.error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #EF4444;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-filters {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .search-input {
                max-width: 100%;
            }
            
            .sessions-table {
                display: none;
            }
            
            .session-card {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                🏦 HR Admin Panel
            </div>
            
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-item">📊 Дашборд</a>
                <a href="/create-candidate-test" class="nav-item">👤 Создать тест</a>
                <a href="/manage-test-sessions" class="nav-item active">📊 Управление тестами</a>
                <a href="/questions" class="nav-item">❓ Вопросы</a>
            </nav>
            
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-name">{{ user.name }}</div>
                    <div class="user-role">{{ user_role_name }}</div>
                </div>
                <a href="/logout" class="btn-logout">🚪 Выйти</a>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="/dashboard">📊 Дашборд</a>
            <span>›</span>
            <span>📊 Управление тестами</span>
        </div>
        
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                📊 Управление тестами
            </h1>
            <p class="page-subtitle">Просмотр и управление созданными тест-сессиями для кандидатов</p>
        </div>
        
        <!-- Messages -->
        <div id="messages"></div>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">📋</div>
                <div class="stat-value" id="total-sessions">{{ stats.total_sessions or 0 }}</div>
                <div class="stat-label">Всего тест-сессий</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⏳</div>
                <div class="stat-value" id="pending-sessions">{{ stats.pending_sessions or 0 }}</div>
                <div class="stat-label">Ожидают начала</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔄</div>
                <div class="stat-value" id="in-progress-sessions">{{ stats.in_progress_sessions or 0 }}</div>
                <div class="stat-label">В процессе</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-value" id="completed-sessions">{{ stats.completed_sessions or 0 }}</div>
                <div class="stat-label">Завершены</div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <div class="search-filters">
                <input type="text" class="search-input" id="search-input" placeholder="Поиск по ФИО кандидата...">
                <select class="filter-select" id="filter-profession">
                    <option value="">Все профессии</option>
                </select>
                <select class="filter-select" id="filter-level">
                    <option value="">Все уровни</option>
                    <option value="junior">Junior</option>
                    <option value="middle">Middle</option>
                    <option value="senior">Senior</option>
                </select>
                <select class="filter-select" id="filter-status">
                    <option value="">Все статусы</option>
                    <option value="pending">Ожидает</option>
                    <option value="in_progress">В процессе</option>
                    <option value="completed">Завершен</option>
                </select>
            </div>
            <a href="/create-candidate-test" class="btn-create">
                👤 Создать тест
            </a>
        </div>
        
        <!-- Test Sessions Section -->
        <div class="sessions-section">
            <div class="section-header">
                <div class="section-title">
                    📋 Тест-сессии
                    <span id="sessions-count">({{ total_sessions }})</span>
                </div>
            </div>
            
            <!-- Desktop Table -->
            <table class="sessions-table" id="sessions-table">
                <thead>
                    <tr>
                        <th>Кандидат</th>
                        <th>Профессия</th>
                        <th>Уровень</th>
                        <th>Создано</th>
                        <th>Статус</th>
                        <th>Ссылка</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="sessions-table-body">
                    <!-- Тест-сессии будут загружены через JavaScript -->
                </tbody>
            </table>
            
            <!-- Mobile Cards -->
            <div id="sessions-cards" class="sessions-cards">
                <!-- Мобильные карточки будут загружены через JavaScript -->
            </div>
            
            <!-- Empty State -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <div class="empty-icon">📋</div>
                <div class="empty-title">Пока нет тест-сессий</div>
                <div class="empty-description">Создайте первый тест для кандидата, чтобы начать работу</div>
                <a href="/create-candidate-test" class="btn-create">
                    👤 Создать первый тест
                </a>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Подтвердите удаление</div>
                <div>Вы уверены, что хотите удалить тест-сессию для "<span id="delete-session-name"></span>"?</div>
            </div>
            <p>Это действие нельзя отменить. Все данные тест-сессии будут удалены.</p>
            <div class="modal-actions">
                <button class="btn btn-modal-cancel" onclick="closeDeleteModal()">Отмена</button>
                <button class="btn btn-modal-delete" onclick="confirmDelete()">Удалить</button>
            </div>
        </div>
    </div>
    
    <script>
        // Глобальные переменные
        let allSessions = [];
        let filteredSessions = [];
        let sessionToDelete = null;
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadTestSessions();
            setupEventListeners();
        });
        
        // Загрузка всех тест-сессий
        async function loadTestSessions() {
            try {
                showLoading(true);
                
                const response = await fetch('/api/test-sessions-overview');
                if (response.ok) {
                    const data = await response.json();
                    allSessions = data.test_sessions || [];
                    filteredSessions = [...allSessions];
                    
                    renderSessions();
                    updateStats(data.stats || {});
                    populateFilters();
                    
                    if (allSessions.length === 0) {
                        showEmptyState(true);
                    }
                } else {
                    showError('Ошибка загрузки тест-сессий');
                }
            } catch (error) {
                console.error('Error loading test sessions:', error);
                showError('Ошибка соединения с сервером');
            } finally {
                showLoading(false);
            }
        }
        
        // Отображение тест-сессий
        function renderSessions() {
            renderDesktopTable();
            renderMobileCards();
            document.getElementById('sessions-count').textContent = `(${filteredSessions.length})`;
            
            showEmptyState(filteredSessions.length === 0);
        }
        

        // Отображение таблицы (desktop)
        function renderDesktopTable() {
            const tbody = document.getElementById('sessions-table-body');
            
            if (filteredSessions.length === 0) {
                tbody.innerHTML = '';
                return;
            }
            
            tbody.innerHTML = filteredSessions.map(session => {
                const candidate = session.candidate || {};
                const profession = session.profession || {};
                const results = session.results || {};
                
                // Формируем ячейку результатов
                let resultsCell = '';
                if (session.status === 'completed' && results.grade) {
                    const gradeColor = getGradeColor(results.grade);
                    resultsCell = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="grade-badge" style="background: ${gradeColor}; color: white; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 1.1rem;">
                                ${results.grade}
                            </div>
                            <div style="font-size: 0.9rem; color: #6B7280;">
                                ${results.percentage}%<br>
                                <span style="font-size: 0.8rem;">${results.correct_answers}/${results.total_questions}</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultsCell = `<span class="status-badge status-${session.status}">${getStatusDisplayName(session.status)}</span>`;
                }
                
                return `
                    <tr>
                        <td>
                            <div class="candidate-name">${candidate.full_name || '-'}</div>
                            ${candidate.phone ? `<div style="font-size: 0.8rem; color: #6B7280;">${candidate.phone}</div>` : ''}
                            ${candidate.email ? `<div style="font-size: 0.8rem; color: #6B7280;">${candidate.email}</div>` : ''}
                        </td>
                        <td>
                            <div>${profession.name || '-'}</div>
                            <div style="font-size: 0.8rem; color: #6B7280;">${profession.specialization || '-'}</div>
                        </td>
                        <td>
                            <span class="session-level level-${session.level}">
                                ${getLevelDisplayName(session.level)}
                            </span>
                        </td>
                        <td>
                            <div>${formatDate(session.created_at)}</div>
                            <div style="font-size: 0.8rem; color: #6B7280;">${formatTime(session.created_at)}</div>
                        </td>
                        <td>
                            ${resultsCell}
                        </td>
                        <td>
                            <div class="test-url" title="${session.test_url}">
                                ${session.test_url}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-copy" onclick="copyTestUrl('${session.test_url}')" title="Копировать ссылку">
                                    📋
                                </button>
                                <button class="btn btn-view" onclick="openTestUrl('${session.test_url}')" title="Открыть тест">
                                    🔗
                                </button>
                                ${session.status === 'completed' ? 
                                    `<button class="btn btn-view" onclick="viewAnswers('${session.test_session_id}')" title="Просмотр ответов">
                                        📋 Ответы
                                    </button>` : ''
                                }
                                <button class="btn btn-delete" onclick="showDeleteModal('${session.test_session_id}', '${candidate.full_name}')" title="Удалить">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Отображение мобильных карточек
        function renderMobileCards() {
            const container = document.getElementById('sessions-cards');
            
            if (filteredSessions.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = filteredSessions.map(session => {
                const candidate = session.candidate || {};
                const profession = session.profession || {};
                const results = session.results || {};
                
                // Формируем блок результатов для мобильной версии
                let resultsBlock = '';
                if (session.status === 'completed' && results.grade) {
                    const gradeColor = getGradeColor(results.grade);
                    resultsBlock = `
                        <div style="display: flex; align-items: center; gap: 15px; justify-content: center; margin: 10px 0;">
                            <div class="grade-badge" style="background: ${gradeColor}; color: white; padding: 8px 12px; border-radius: 8px; font-weight: 700; font-size: 1.5rem;">
                                ${results.grade}
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #2C3E50;">${results.percentage}%</div>
                                <div style="font-size: 0.8rem; color: #6B7280;">${results.correct_answers}/${results.total_questions} правильных</div>
                            </div>
                        </div>
                    `;
                } else {
                    resultsBlock = `
                        <div style="text-align: center; margin: 10px 0;">
                            <span class="status-badge status-${session.status}">${getStatusDisplayName(session.status)}</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="session-card">
                        <div class="session-card-header">
                            <div>
                                <div class="candidate-name">${candidate.full_name || '-'}</div>
                                <div class="session-profession">${profession.name || '-'} - ${profession.specialization || '-'}</div>
                                <span class="session-level level-${session.level}">
                                    ${getLevelDisplayName(session.level)}
                                </span>
                            </div>
                        </div>
                        
                        ${resultsBlock}
                        
                        <div class="session-info">
                            <div class="info-item">
                                <div class="info-value">${formatDateShort(session.created_at)}</div>
                                <div class="info-label">Создано</div>
                            </div>
                            <div class="info-item">
                                <div class="info-value">15</div>
                                <div class="info-label">Вопросов</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-copy" onclick="copyTestUrl('${session.test_url}')">
                                📋 Копировать ссылку
                            </button>
                            <button class="btn btn-view" onclick="openTestUrl('${session.test_url}')">
                                🔗 Открыть тест
                            </button>
                            ${session.status === 'completed' ? 
                                `<button class="btn btn-view" onclick="viewAnswers('${session.test_session_id}')">
                                    📋 Ответы
                                </button>` : ''
                            }
                            <button class="btn btn-delete" onclick="showDeleteModal('${session.test_session_id}', '${candidate.full_name}')">
                                🗑️ Удалить
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Обновление статистики
        function updateStats(stats) {
            document.getElementById('total-sessions').textContent = stats.total_sessions || 0;
            document.getElementById('pending-sessions').textContent = stats.pending_sessions || 0;
            document.getElementById('in-progress-sessions').textContent = stats.in_progress_sessions || 0;
            document.getElementById('completed-sessions').textContent = stats.completed_sessions || 0;
        }
        
        // Заполнение фильтров
        function populateFilters() {
            const professionFilter = document.getElementById('filter-profession');
            const professions = [...new Set(allSessions.map(session => session.profession?.name).filter(Boolean))];
            
            professionFilter.innerHTML = '<option value="">Все профессии</option>' + 
                professions.map(profession => `<option value="${profession}">${profession}</option>`).join('');
        }
        
        // Настройка слушателей событий
        function setupEventListeners() {
            // Поиск и фильтры
            document.getElementById('search-input').addEventListener('input', filterSessions);
            document.getElementById('filter-profession').addEventListener('change', filterSessions);
            document.getElementById('filter-level').addEventListener('change', filterSessions);
            document.getElementById('filter-status').addEventListener('change', filterSessions);
            
            // Закрытие модального окна по клику вне его
            document.getElementById('delete-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDeleteModal();
                }
            });
        }
        
        // Фильтрация тест-сессий
        function filterSessions() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const professionFilter = document.getElementById('filter-profession').value;
            const levelFilter = document.getElementById('filter-level').value;
            const statusFilter = document.getElementById('filter-status').value;
            
            filteredSessions = allSessions.filter(session => {
                const candidate = session.candidate || {};
                const profession = session.profession || {};
                
                const matchesSearch = !searchTerm || 
                    candidate.full_name?.toLowerCase().includes(searchTerm) ||
                    candidate.phone?.toLowerCase().includes(searchTerm) ||
                    candidate.email?.toLowerCase().includes(searchTerm) ||
                    profession.name?.toLowerCase().includes(searchTerm);
                
                const matchesProfession = !professionFilter || profession.name === professionFilter;
                const matchesLevel = !levelFilter || session.level === levelFilter;
                const matchesStatus = !statusFilter || session.status === statusFilter;
                
                return matchesSearch && matchesProfession && matchesLevel && matchesStatus;
            });
            
            renderSessions();
        }
        
        // Копирование ссылки на тест
        async function copyTestUrl(testUrl) {
            try {
                await navigator.clipboard.writeText(testUrl);
                showSuccess('Ссылка скопирована в буфер обмена!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                // Fallback для старых браузеров
                const textArea = document.createElement("textarea");
                textArea.value = testUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Ссылка скопирована!');
            }
        }
        
        // Открытие ссылки на тест
        function openTestUrl(testUrl) {
            window.open(testUrl, '_blank');
        }
        
        // Показать модальное окно удаления
        function showDeleteModal(sessionId, candidateName) {
            sessionToDelete = sessionId;
            document.getElementById('delete-session-name').textContent = candidateName;
            document.getElementById('delete-modal').style.display = 'block';
        }
        
        // Закрыть модальное окно удаления
        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            sessionToDelete = null;
        }
        
        // Подтвердить удаление
        async function confirmDelete() {
            if (!sessionToDelete) return;
            
            try {
                showLoading(true);
                
                const response = await fetch(`/api/test-session/${sessionToDelete}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Тест-сессия успешно удалена');
                    closeDeleteModal();
                    loadTestSessions(); // Перезагружаем список
                } else {
                    showError(result.error || 'Ошибка удаления тест-сессии');
                }
            } catch (error) {
                console.error('Error deleting test session:', error);
                showError('Ошибка соединения с сервером');
            } finally {
                showLoading(false);
            }
        }
        
        // Показать пустое состояние
        function showEmptyState(show) {
            const emptyState = document.getElementById('empty-state');
            const sessionsTable = document.getElementById('sessions-table');
            const sessionsCards = document.getElementById('sessions-cards');
            
            if (show) {
                emptyState.style.display = 'block';
                sessionsTable.style.display = 'none';
                sessionsCards.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                sessionsTable.style.display = 'table';
                sessionsCards.style.display = 'block';
            }
        }
        
        // Показать состояние загрузки
        function showLoading(show) {
            const container = document.querySelector('.container');
            if (show) {
                container.classList.add('loading');
            } else {
                container.classList.remove('loading');
            }
        }
        
        // Показать сообщения
        function showSuccess(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="message success">✅ ${message}</div>`;
            setTimeout(() => messagesDiv.innerHTML = '', 3000);
        }
        
        function showError(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="message error">❌ ${message}</div>`;
        }
        
        // Утилиты форматирования
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDateShort(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Сегодня';
            if (diffDays === 1) return 'Вчера';
            if (diffDays < 7) return `${diffDays} дн. назад`;
            
            return formatDate(dateString);
        }
        
        function getLevelDisplayName(level) {
            const names = {
                'junior': 'Junior',
                'middle': 'Middle',
                'senior': 'Senior'
            };
            return names[level] || level;
        }
        
        function getStatusDisplayName(status) {
            const names = {
                'pending': 'Ожидает',
                'in_progress': 'В процессе',
                'completed': 'Завершен'
            };
            return names[status] || status;
        }

        // === ФУНКЦИИ ПРОСМОТРА ОТВЕТОВ ===

        async function viewAnswers(sessionId) {
            try {
                const response = await fetch(`/api/test-session-answers/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    showAnswersModal(data);
                } else {
                    showError('Ошибка загрузки ответов: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showError('Ошибка загрузки ответов');
            }
        }

        function showAnswersModal(data) {
            const { test_session, answers_details } = data;
            const results = test_session.results || {};
            
            // Формируем заголовок с оценкой
            let headerHTML = `
                <div class="modal-header" style="margin-bottom: 20px; text-align: center;">
                    <h2 style="color: #8B5CF6; margin: 0 0 15px 0;">📋 Ответы кандидата</h2>
                    <p style="margin: 0 0 10px 0; color: #6B7280;">
                        <strong>${test_session.candidate.full_name}</strong><br>
                        ${test_session.profession.name} (${test_session.level})
                    </p>
            `;
            
            if (results.grade) {
                const gradeColor = getGradeColor(results.grade);
                headerHTML += `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 12px;">
                        <div class="grade-display" style="text-align: center;">
                            <div style="font-size: 4rem; font-weight: 900; color: ${gradeColor}; line-height: 1;">${results.grade}</div>
                            <div style="font-size: 1.2rem; font-weight: 600; color: ${gradeColor};">${results.grade_text}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2D3748;">${results.percentage}%</div>
                            <div style="color: #6B7280; margin-top: 5px;">
                                ${results.correct_answers}/${results.total_questions} правильных<br>
                                <span style="font-size: 0.9rem;">Время: ${Math.floor((test_session.time_spent || 0) / 60)}м</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Добавляем разбивку по категориям если есть
                if (results.category_breakdown && Object.keys(results.category_breakdown).length > 0) {
                    headerHTML += `
                        <div style="margin: 20px 0;">
                            <h4 style="color: #2D3748; margin-bottom: 15px; text-align: center;">📊 Результаты по областям</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    `;
                    
                    Object.entries(results.category_breakdown).forEach(([categoryName, data]) => {
                        const categoryGradeColor = getGradeColor(data.grade);
                        headerHTML += `
                            <div style="background: white; border: 2px solid ${categoryGradeColor}; border-radius: 8px; padding: 10px; text-align: center; min-width: 120px;">
                                <div style="font-weight: 600; color: #2D3748; font-size: 0.9rem;">${categoryName}</div>
                                <div style="color: ${categoryGradeColor}; font-weight: 700; font-size: 1.1rem;">${data.grade}</div>
                                <div style="color: #6B7280; font-size: 0.8rem;">${data.percentage}%</div>
                            </div>
                        `;
                    });
                    
                    headerHTML += '</div></div>';
                }
            }
            
            headerHTML += '</div>';
            
            let modalHTML = `
                <div class="modal-overlay" onclick="closeAnswersModal()" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                    align-items: center; justify-content: center;">
                    
                    <div class="modal-content" onclick="event.stopPropagation()" style="
                        background: white; border-radius: 15px; max-width: 900px; 
                        max-height: 90vh; overflow-y: auto; padding: 30px; margin: 20px;">
                        
                        ${headerHTML}
                        
                        <div class="answers-list">`;
            
            answers_details.forEach((answer, index) => {
                const isCorrect = answer.is_correct;
                const statusIcon = isCorrect ? '✅' : '❌';
                const statusColor = isCorrect ? '#1DB584' : '#EF4444';
                
                modalHTML += `
                    <div class="answer-item" style="
                        border: 2px solid ${statusColor}; border-radius: 10px; 
                        padding: 20px; margin-bottom: 20px; background: ${isCorrect ? '#F0FDF4' : '#FEF2F2'};">
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #2D3748;">Вопрос ${index + 1}</h4>
                            <span style="font-size: 1.5rem;">${statusIcon}</span>
                        </div>
                        
                        <div style="margin-bottom: 15px; font-weight: 500; line-height: 1.5;">
                            ${answer.question}
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #4A5568;">Ответ кандидата:</strong> 
                            <span style="color: ${statusColor}; font-weight: 500;">
                                ${answer.user_answer || 'Не отвечено'}
                            </span>
                        </div>
                        
                        <div>
                            <strong style="color: #4A5568;">Правильный ответ:</strong> 
                            <span style="color: #1DB584; font-weight: 500;">
                                ${answer.correct_answer}
                            </span>
                        </div>
                    </div>`;
            });
            
            modalHTML += `
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="closeAnswersModal()" style="
                                background: #8B5CF6; color: white; border: none; 
                                padding: 12px 24px; border-radius: 8px; font-size: 16px; 
                                cursor: pointer; font-weight: 500;">
                                Закрыть
                            </button>
                        </div>
                    </div>
                </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAnswersModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function getGradeColor(grade) {
            const colors = {
                'A': '#1DB584',
                'B': '#059669', 
                'C': '#F59E0B',
                'D': '#F97316',
                'F': '#EF4444'
            };
            return colors[grade] || '#EF4444';
        }

    </script>
</body>
</html>