<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ –¢–µ—Å—Ç –∞—É–¥–∏–æ –ø—Ä–æ–∫—Ç–æ—Ä–∏–Ω–≥–∞ - Halyk Bank</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; }
        
        :root {
            --primary: #1DB584;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, var(--primary) 0%, #059669 100%);
            min-height: 100vh;
            color: var(--gray-900);
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--gray-900) 0%, #1F2937 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .header p {
            margin: 0;
            opacity: 0.8;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .test-section {
            background: var(--gray-50);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid var(--primary);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(29, 181, 132, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: #159A73;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .status-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .status-card.success {
            border-color: var(--success);
            background: #F0FDF4;
        }

        .status-card.warning {
            border-color: var(--warning);
            background: #FFFBEB;
        }

        .status-card.danger {
            border-color: var(--danger);
            background: #FEF2F2;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--gray-500);
            text-align: center;
            margin-top: 5px;
        }

        .log-container {
            background: var(--gray-900);
            color: #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .log-entry.success { border-color: var(--success); color: #10B981; }
        .log-entry.warning { border-color: var(--warning); color: #F59E0B; }
        .log-entry.danger { border-color: var(--danger); color: #EF4444; }
        .log-entry.info { border-color: #3B82F6; color: #60A5FA; }

        .recording-indicator {
            display: none;
            background: var(--danger);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            margin: 10px 0;
            animation: pulse 1s infinite;
        }

        .recording-indicator.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--gray-200);
            text-align: center;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .result-label {
            color: var(--gray-500);
            font-size: 0.9rem;
        }

        .instructions {
            background: #EBF8FF;
            border: 1px solid #3B82F6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .instructions h3 {
            color: #1E40AF;
            margin: 0 0 15px 0;
        }

        .instructions ul {
            margin: 0;
            padding-left: 20px;
            line-height: 1.6;
        }

        .audio-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .audio-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>üé§ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ –ø—Ä–æ–∫—Ç–æ—Ä–∏–Ω–≥–∞</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≥–æ–≤–æ—Ä—è—â–µ–≥–æ</p>
        </div>

        <div class="content">
            <!-- –≠–¢–ê–ü 1: –ö–ê–õ–ò–ë–†–û–í–ö–ê –ì–û–õ–û–°–ê -->
            <div class="test-section" id="calibration-section">
                <div class="section-title">
                    üéØ –≠—Ç–∞–ø 1: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –≥–æ–ª–æ—Å–∞
                </div>

                <div class="instructions">
                    <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ:</h3>
                    <ul>
                        <li>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É" –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</li>
                        <li>–ü—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—É—é —Ñ—Ä–∞–∑—É —Å–≤–æ–∏–º –æ–±—ã—á–Ω—ã–º –≥–æ–ª–æ—Å–æ–º</li>
                        <li>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ñ—Ä–∞–∑—É 2-3 —Ä–∞–∑–∞ —á–µ—Ç–∫–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ</li>
                        <li>–ò–∑–±–µ–≥–∞–π—Ç–µ —Ñ–æ–Ω–æ–≤–æ–≥–æ —à—É–º–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏</li>
                        <li>–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 5-10 —Å–µ–∫—É–Ω–¥)</li>
                    </ul>
                </div>

                <div class="audio-controls">
                    <button class="btn btn-primary" id="start-calibration-btn" onclick="startCalibration()">
                        üöÄ –ù–∞—á–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
                    </button>
                    <button class="btn btn-success hidden" id="finish-calibration-btn" onclick="finishCalibration()">
                        ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
                    </button>
                </div>

                <div class="recording-indicator" id="recording-indicator">
                    üé§ –ò–î–ï–¢ –ó–ê–ü–ò–°–¨ - –ì–æ–≤–æ—Ä–∏—Ç–µ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—É—é —Ñ—Ä–∞–∑—É
                </div>

                <div class="status-card" id="calibration-status">
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> –ì–æ—Ç–æ–≤ –∫ –Ω–∞—á–∞–ª—É –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="calibration-progress"></div>
                </div>
                <div class="progress-text" id="calibration-progress-text">
                    –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                </div>

                <div id="calibration-phrase" class="instructions hidden">
                    <h3>üó£Ô∏è –ü—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ —ç—Ç—É —Ñ—Ä–∞–∑—É:</h3>
                    <p id="phrase-text" style="font-size: 1.1rem; font-weight: 500; line-height: 1.6;"></p>
                </div>
            </div>

            <!-- –≠–¢–ê–ü 2: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï -->
            <div class="test-section hidden" id="testing-section">
                <div class="section-title">
                    üß™ –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                </div>

                <div class="instructions">
                    <h3>üî¨ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:</h3>
                    <ul>
                        <li><strong>–¢–µ—Å—Ç "—Å–≤–æ–π –≥–æ–ª–æ—Å":</strong> –ì–æ–≤–æ—Ä–∏—Ç–µ —á—Ç–æ-—Ç–æ —Å–∞–º–∏ - —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å "–ö–ê–ù–î–ò–î–ê–¢"</li>
                        <li><strong>–¢–µ—Å—Ç "—á—É–∂–æ–π –≥–æ–ª–æ—Å":</strong> –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∫–æ–≥–æ-—Ç–æ –¥—Ä—É–≥–æ–≥–æ –≥–æ–≤–æ—Ä–∏—Ç—å - —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å "–ù–ï –ö–ê–ù–î–ò–î–ê–¢"</li>
                        <li>–ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</li>
                        <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ—á–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Ä–µ—á–∏</li>
                    </ul>
                </div>

                <div class="audio-controls">
                    <button class="btn btn-primary" id="start-test-btn" onclick="startTesting()">
                        üé§ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
                    </button>
                    <button class="btn btn-warning hidden" id="stop-test-btn" onclick="stopTesting()">
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <div class="recording-indicator" id="test-recording-indicator">
                    üé§ –ò–î–ï–¢ –ê–ù–ê–õ–ò–ó - –ì–æ–≤–æ—Ä–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å
                </div>

                <div class="results-grid" id="test-results">
                    <div class="result-item">
                        <div class="result-value" id="speaker-result">-</div>
                        <div class="result-label">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–≤–æ—Ä—è—â–µ–≥–æ</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="confidence-result">-</div>
                        <div class="result-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (%)</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="processing-time">-</div>
                        <div class="result-label">–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å–µ–∫)</div>
                    </div>
                </div>

                <div class="status-card" id="last-transcription">
                    <strong>–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:</strong> <span id="transcription-text">-</span>
                </div>
            </div>

            <!-- –õ–û–ì–ò –°–ò–°–¢–ï–ú–´ -->
            <div class="test-section">
                <div class="section-title">
                    üìä –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
                </div>
                <div class="log-container" id="system-logs">
                    <div class="log-entry info">[–°–∏—Å—Ç–µ–º–∞] –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        let currentSessionId = null;
        let isCalibrating = false;
        let isTesting = false;
        let mediaRecorder = null;
        let audioStream = null;
        let calibrationSamplesCount = 0;
        let minCalibrationSamples = 5;
        let selectedMimeType = null; // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

        // === –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ===
        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('system-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
            if (logsContainer.children.length > 50) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–ò–ö–†–û–§–û–ù–ê ===
        async function initializeMicrophone() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: false,
                        noiseSuppression: false
                    }
                });
                
                addLog('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                return true;
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`, 'danger');
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
                return false;
            }
        }

        // === –ö–ê–õ–ò–ë–†–û–í–ö–ê ===
        async function startCalibration() {
            try {
                addLog('–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏...', 'info');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                if (!await initializeMicrophone()) {
                    return;
                }

                // –ó–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—á–∞–ª–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                const response = await fetch('/api/audio/start-calibration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    currentSessionId = result.session_id;
                    calibrationSamplesCount = 0;
                    minCalibrationSamples = result.min_required || 5;

                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    document.getElementById('start-calibration-btn').style.display = 'none';
                    document.getElementById('calibration-phrase').classList.remove('hidden');
                    document.getElementById('phrase-text').textContent = result.calibration_phrase;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    updateCalibrationStatus('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—á–∞—Ç–∞. –ì–æ–≤–æ—Ä–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Ñ—Ä–∞–∑—É.', 'info');

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    updateProgress(0, '–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –æ–±—Ä–∞–∑—Ü–æ–≤ –≥–æ–ª–æ—Å–∞...');

                    addLog(`–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—á–∞—Ç–∞ (—Å–µ—Å—Å–∏—è: ${currentSessionId})`, 'success');
                    addLog(`–¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º ${minCalibrationSamples} –æ–±—Ä–∞–∑—Ü–æ–≤`, 'info');

                    // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å –æ–±—Ä–∞–∑—Ü–æ–≤
                    startRecordingCalibrationSamples();

                } else {
                    addLog(`–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏: ${result.error}`, 'danger');
                    updateCalibrationStatus(`–û—à–∏–±–∫–∞: ${result.error}`, 'danger');
                }

            } catch (error) {
                addLog(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏: ${error.message}`, 'danger');
                updateCalibrationStatus(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'danger');
            }
        }


        // –ó–ê–ú–ï–ù–ò —Ñ—É–Ω–∫—Ü–∏—é startRecordingCalibrationSamples() –ù–ê –≠–¢–£

        function startRecordingCalibrationSamples() {
            if (!audioStream) {
                addLog('–ê—É–¥–∏–æ–ø–æ—Ç–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'danger');
                return;
            }

            isCalibrating = true;
            document.getElementById('recording-indicator').classList.add('active');

            try {
                addLog('üîß –ë—Ä–∞—É–∑–µ—Ä: Chrome - —Ç–æ–ª—å–∫–æ WebM –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'info');
                
                // –†–∞–∑ Chrome –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ WebM, –≤—ã–±–µ—Ä–µ–º –õ–£–ß–®–ò–ô WebM —Ñ–æ—Ä–º–∞—Ç
                let mimeType = '';
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç WebM —Ñ–æ—Ä–º–∞—Ç–æ–≤ (–æ—Ç –ª—É—á—à–µ–≥–æ –∫ —Ö—É–¥—à–µ–º—É –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏)
                const webmFormats = [
                    'audio/webm;codecs=pcm',    // PCM –≤ WebM (–ª—É—á—à–∏–π –¥–ª—è Whisper)
                    'audio/webm;codecs=opus',   // Opus —Å–∂–∞—Ç–∏–µ
                    'audio/webm'                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                ];
                
                for (const format of webmFormats) {
                    if (MediaRecorder.isTypeSupported(format)) {
                        mimeType = format;
                        addLog(`‚úÖ –í—ã–±—Ä–∞–Ω –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π WebM: ${format}`, 'success');
                        break;
                    }
                }
                
                if (!mimeType) {
                    mimeType = 'audio/webm'; // Fallback
                    addLog('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π WebM —Ñ–æ—Ä–º–∞—Ç', 'warning');
                }
                
                selectedMimeType = mimeType;
                
                // –°–æ–∑–¥–∞–µ–º MediaRecorder
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: mimeType });
                
                addLog(`üé¨ MediaRecorder —Å–æ–∑–¥–∞–Ω: ${mediaRecorder.mimeType}`, 'info');
                addLog('üí° WebM –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ Raw PCM extraction', 'info');

                let audioChunks = [];
                let recordingStartTime = Date.now();

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π MIME type MediaRecorder'–∞
                    const detectedMimeType = mediaRecorder.mimeType || mimeType;
                    const audioBlob = new Blob(audioChunks, { type: detectedMimeType });
                    const recordingDuration = (Date.now() - recordingStartTime) / 1000;

                    addLog(`üì¶ WebM Blob: ${audioBlob.size} –±–∞–π—Ç (${recordingDuration.toFixed(1)}—Å)`, 'success');

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–∑–µ—Ü –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    await sendCalibrationSample(audioBlob);

                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (isCalibrating && calibrationSamplesCount < minCalibrationSamples) {
                        setTimeout(() => {
                            if (isCalibrating) {
                                startRecordingCalibrationSamples();
                            }
                        }, 1000);
                    }
                };

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º 3-—Å–µ–∫—É–Ω–¥–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã
                mediaRecorder.start();
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 3000);

            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`, 'danger');
                isCalibrating = false;
                document.getElementById('recording-indicator').classList.remove('active');
            }
        }

        // –¢–ê–ö–ñ–ï –ó–ê–ú–ï–ù–ò startContinuousAnalysis() –ù–ê –≠–¢–£

        function startContinuousAnalysis() {
            if (!isTesting || !audioStream) return;

            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π WebM —Ñ–æ—Ä–º–∞—Ç
                let mimeType = selectedMimeType || 'audio/webm;codecs=pcm';
                
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }
                
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: mimeType });

                let audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    if (audioChunks.length > 0) {
                        const detectedMimeType = mediaRecorder.mimeType || mimeType;
                        const audioBlob = new Blob(audioChunks, { type: detectedMimeType });
                        
                        await analyzeAudioSample(audioBlob);
                    }

                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑
                    if (isTesting) {
                        setTimeout(() => {
                            if (isTesting) {
                                startContinuousAnalysis();
                            }
                        }, 500);
                    }
                };

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º 2-—Å–µ–∫—É–Ω–¥–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                mediaRecorder.start();
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 2000);

            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${error.message}`, 'danger');
                stopTesting();
            }
        }

        async function sendCalibrationSample(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('session_id', currentSessionId);
                formData.append('audio_data', audioBlob, 'sample.webm');

                const response = await fetch('/api/audio/add-sample', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    calibrationSamplesCount = result.samples_collected;
                    const progress = result.progress_percent;
                    
                    addLog(`–û–±—Ä–∞–∑–µ—Ü ${calibrationSamplesCount} –¥–æ–±–∞–≤–ª–µ–Ω. –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: "${result.transcription}"`, 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    updateProgress(progress, `–û–±—Ä–∞–∑—Ü–æ–≤ —Å–æ–±—Ä–∞–Ω–æ: ${calibrationSamplesCount}/${result.min_required}`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–±—Ä–∞–∑—Ü–æ–≤
                    if (result.can_finish_calibration) {
                        document.getElementById('finish-calibration-btn').classList.remove('hidden');
                        updateCalibrationStatus(`–°–æ–±—Ä–∞–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–±—Ä–∞–∑—Ü–æ–≤ (${calibrationSamplesCount}). –ú–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.`, 'success');
                    }

                } else {
                    addLog(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞–∑—Ü–∞: ${result.error}`, 'warning');
                }

            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞–∑—Ü–∞: ${error.message}`, 'danger');
            }
        }

        async function finishCalibration() {
            try {
                isCalibrating = false;
                document.getElementById('recording-indicator').classList.remove('active');

                addLog('–ó–∞–≤–µ—Ä—à–∞–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É...', 'info');

                const response = await fetch('/api/audio/finish-calibration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId })
                });

                const result = await response.json();

                if (result.success) {
                    updateCalibrationStatus('‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    updateProgress(100, '–ì–æ–ª–æ—Å–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω');

                    addLog(`–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ö–∞—á–µ—Å—Ç–≤–æ: ${result.profile_stats.quality_score}`, 'success');
                    addLog(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –æ–±—Ä–∞–∑—Ü–æ–≤: ${result.profile_stats.samples_used}`, 'info');

                    // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                    setTimeout(() => {
                        document.getElementById('testing-section').classList.remove('hidden');
                        document.getElementById('testing-section').scrollIntoView({ behavior: 'smooth' });
                    }, 2000);

                } else {
                    addLog(`–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏: ${result.error}`, 'danger');
                    updateCalibrationStatus(`–û—à–∏–±–∫–∞: ${result.error}`, 'danger');
                }

            } catch (error) {
                addLog(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'danger');
                updateCalibrationStatus(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'danger');
            }
        }

        // === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ===
        async function startTesting() {
            if (!currentSessionId) {
                addLog('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫—É', 'warning');
                return;
            }

            isTesting = true;
            document.getElementById('start-test-btn').classList.add('hidden');
            document.getElementById('stop-test-btn').classList.remove('hidden');
            document.getElementById('test-recording-indicator').classList.add('active');

            addLog('–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...', 'success');

            // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é –∑–∞–ø–∏—Å—å –∏ –∞–Ω–∞–ª–∏–∑
            startContinuousAnalysis();
        }


        async function analyzeAudioSample(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('session_id', currentSessionId);
                formData.append('audio_data', audioBlob, 'test.webm');

                const response = await fetch('/api/audio/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const analysis = result.result;
                    const transcription = analysis.transcription;
                    const speaker = analysis.speaker_identification;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                    const speakerText = speaker.is_candidate ? "üü¢ –ö–ê–ù–î–ò–î–ê–¢" : "üî¥ –ù–ï –ö–ê–ù–î–ò–î–ê–¢";
                    const confidence = Math.round(speaker.confidence * 100);
                    const processingTime = transcription.processing_time || 0;

                    document.getElementById('speaker-result').textContent = speakerText;
                    document.getElementById('confidence-result').textContent = `${confidence}%`;
                    document.getElementById('processing-time').textContent = `${processingTime.toFixed(1)}`;
                    document.getElementById('transcription-text').textContent = transcription.text || '–ù–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–π —Ä–µ—á–∏';

                    // –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    const speakerElement = document.getElementById('speaker-result').parentElement;
                    speakerElement.style.borderColor = speaker.is_candidate ? 'var(--success)' : 'var(--danger)';

                    const confidenceElement = document.getElementById('confidence-result').parentElement;
                    if (confidence > 80) {
                        confidenceElement.style.borderColor = 'var(--success)';
                    } else if (confidence > 50) {
                        confidenceElement.style.borderColor = 'var(--warning)';
                    } else {
                        confidenceElement.style.borderColor = 'var(--danger)';
                    }

                    // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    const logType = speaker.is_candidate ? 'success' : 'warning';
                    addLog(`${speakerText} (${confidence}%) - "${transcription.text}"`, logType);

                } else {
                    // –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∏—à–∏–Ω–∞)
                    if (result.error && !result.error.includes('–∫–æ—Ä–æ—Ç–∫–æ–µ') && !result.error.includes('–ø—É—Å—Ç—ã–µ')) {
                        addLog(`–ê–Ω–∞–ª–∏–∑: ${result.error}`, 'warning');
                    }
                }

            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –∞–Ω–∞–ª–∏–∑: ${error.message}`, 'danger');
            }
        }

        function stopTesting() {
            isTesting = false;
            document.getElementById('start-test-btn').classList.remove('hidden');
            document.getElementById('stop-test-btn').classList.add('hidden');
            document.getElementById('test-recording-indicator').classList.remove('active');

            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            addLog('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
        }

        // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        function updateCalibrationStatus(message, type) {
            const statusCard = document.getElementById('calibration-status');
            statusCard.innerHTML = `<strong>–°—Ç–∞—Ç—É—Å:</strong> ${message}`;
            statusCard.className = `status-card ${type}`;
        }

        function updateProgress(percent, text) {
            document.getElementById('calibration-progress').style.width = `${percent}%`;
            document.getElementById('calibration-progress-text').textContent = text;
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        document.addEventListener('DOMContentLoaded', function() {
            addLog('–°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏–æ –ø—Ä–æ–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            addLog('–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã', 'info');
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>